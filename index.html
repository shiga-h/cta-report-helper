<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CTA Report Helper（CTOスコア対応＋特殊所見チェック式）</title>
  <style>
    :root { --gap:12px; --fg:#111; --muted:#666; --border:#ddd; --pill:#f5f5f5; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
           margin: 16px; color: var(--fg); }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .row { display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    .ctrl { height:40px; padding: 8px 12px; font-size:16px; }
    select.ctrl, input.ctrl { border:1px solid var(--border); border-radius:8px; }
    button.ctrl { background:#111; color:#fff; border:none; border-radius:8px; }
    button.ghost { background:#fff; color:#111; border:1px solid var(--border); }
    button:disabled { opacity:.6; }
    .hint { color:var(--muted); font-size:13px; }
    .section { margin: 16px 0; }
    #preview { width:100%; height:280px; border:1px solid var(--border); border-radius:8px;
               font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
               padding:12px; white-space:pre-wrap; }
    .grid { display:grid; grid-template-columns: 140px 1fr; gap:10px 12px; align-items:center; }
    fieldset { border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    legend { padding:0 6px; color:#333; font-weight:600; }
    .pill { padding:3px 8px; border:1px solid var(--border); border-radius:999px; background:var(--pill); }
    .scoreBadge { padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-weight:600; }
    .checklist { display:flex; flex-wrap:wrap; gap:8px; }
    .checkItem { padding:5px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; user-select:none; }
    .checkItem.active { background:#007bff; color:#fff; border-color:#007bff; }
    @media (max-width:560px){
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>CTA Report Helper（CTOスコア対応＋特殊所見チェック式）</h1>

  <div class="row section">
    <label for="tplSel">テンプレート選択</label>
    <select id="tplSel" class="ctrl">
      <option value="coronary_ct" selected>冠動脈</option>
      <option value="bypass_ct">バイパス</option>
      <option value="laa_pv_ct">左心耳・肺静脈</option>
      <option value="tavi">TAVI</option>
    </select>
  </div>

  <div class="row section">
    <label for="scoreInput">スコア：</label>
    <input id="scoreInput" class="ctrl" placeholder="例：450" />
  </div>

  <!-- 所見入力 -->
  <div id="lesionArea" class="section">
    <div class="grid">
      <label>枝</label>
      <div class="row">
        <select id="arterySel" class="ctrl"></select>
        <input id="arteryFree" class="ctrl" placeholder="その他（手入力）" style="display:none; width:220px;" />
      </div>

      <label>狭窄率</label>
      <select id="stenosisSel" class="ctrl" style="width:220px;"></select>

      <label>プラーク</label>
      <select id="plaqueSel" class="ctrl" style="width:220px;"></select>

      <label>特殊所見</label>
      <div id="specialChecks" class="checklist"></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="addLineBtn" class="ctrl">この内容で1行追加</button>
      <span class="hint">特殊所見はクリックでON/OFF選択できます</span>
    </div>
  </div>

  <!-- CTO -->
  <div class="row section">
    <span class="pill"><label><input type="checkbox" id="ctoToggle" /> CTO症例</label></span>
    <span id="jctoBadge" class="scoreBadge" style="display:none;">J-CTO: 0点（Easy）</span>
  </div>

  <div id="ctoBlock" class="section" style="display:none;">
    <fieldset>
      <legend>CTO（J-CTOスコア算出＋α）</legend>
      <div class="grid">
        <label>蛇行</label>
        <select id="ctoBend" class="ctrl">
          <option value="none">≤45°</option>
          <option value="gt45">&gt;45°</option>
        </select>
        <label>石灰化</label>
        <select id="ctoCalc" class="ctrl">
          <option value="none">なし/軽度</option>
          <option value="present">あり</option>
        </select>
        <label>入口部</label>
        <select id="ctoStump" class="ctrl">
          <option value="tapered">tapered</option>
          <option value="blunt">blunt</option>
        </select>
        <label>閉塞長</label>
        <select id="ctoLen" class="ctrl">
          <option value="<20">&lt;20mm</option>
          <option value=">=20">≥20mm</option>
        </select>
        <label>既治療歴</label>
        <select id="ctoPrior" class="ctrl">
          <option value="no">なし</option>
          <option value="yes">あり</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="addJCTOScoreBtn" class="ctrl">J-CTOスコアを1行追加</button>
      </div>
    </fieldset>
  </div>

  <div class="section">
    <button id="copyBtn" class="ctrl">コピー</button>
    <button id="mailtoBtn" class="ctrl ghost">メール作成</button>
  </div>

  <div class="section">
    <div id="preview"></div>
  </div>

  <script>
    const TPL_FALLBACKS = {
      "coronary_ct": {
        meta:{title:"＜冠動脈＞（担当技師：志賀）",score_label:"石灰化スコア："},
        sections:[{
          fields:[
            {key:"artery",options:["#1","#2","#3","#4PL","#4PD","#5","#6","#7","#8","#9","#10","#11","#12","#13","#14","#15","HL","PL","Sep","その他（手入力）"]},
            {key:"stenosis",options:["25%","25-50%","50%","50-75%","75%","75-90%","90%","99%","99-100%","100%"]},
            {key:"plaque",options:["非石灰化プラーク","混合プラーク","石灰化プラーク","石灰化プラークあり"]},
            {key:"special",options:["Positive remodeling","Spotty calcification","Napkin-ring sign","Low attenuation plaque","Myocardial bridge(+)","モーションアーチファクトのため正確な内腔評価困難です。","血管径1.5mm以下のため正確な内腔評価困難です。"]}
          ]
        }]
      }
    };

    let outputLines=[], outputText="";

    function fillSelect(sel,opts){ sel.innerHTML=""; opts.forEach(o=>{const op=document.createElement("option");op.textContent=o;op.value=o;sel.appendChild(op);});}

    function prepareUI(){
      const tpl=TPL_FALLBACKS["coronary_ct"].sections[0].fields;
      fillSelect(arterySel,tpl[0].options);
      fillSelect(stenosisSel,tpl[1].options);
      fillSelect(plaqueSel,tpl[2].options);

      const sDiv=document.getElementById("specialChecks");
      sDiv.innerHTML="";
      tpl[3].options.forEach(txt=>{
        const d=document.createElement("div");
        d.className="checkItem";
        d.textContent=txt;
        d.onclick=()=>d.classList.toggle("active");
        sDiv.appendChild(d);
      });
    }

    function specialsSelected(){
      return Array.from(document.querySelectorAll(".checkItem.active")).map(el=>el.textContent);
    }

    function renderOutput(){
      document.getElementById("preview").textContent=outputText+outputLines.join("\n");
    }

    addLineBtn.onclick=()=>{
      const a=(arterySel.value==="その他（手入力）")?(arteryFree.value||"不明"):arterySel.value;
      const s=stenosisSel.value, p=plaqueSel.value;
      const sp=specialsSelected(); const spStr=sp.length?`（${sp.join(", ")}）`:"";
      const line=`${a}： ${s} ${p}${spStr}`;
      outputLines.push(line); renderOutput();
    };

    copyBtn.onclick=async()=>{await navigator.clipboard.writeText(document.getElementById("preview").textContent);alert("コピーしました");};
    mailtoBtn.onclick=()=>{location.href=`mailto:?subject=CTA所見&body=${encodeURIComponent(document.getElementById("preview").textContent)}`;};

    (function init(){
      outputText="＜冠動脈＞（担当技師：志賀）\n石灰化スコア：\n";
      prepareUI(); renderOutput();
    })();
  </script>
</body>
</html>
