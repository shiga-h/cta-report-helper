<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CTA Report Helper（テンプレ切替・スマホ最適化）</title>
  <style>
    :root { --gap:12px; --fg:#111; --muted:#666; --border:#ddd; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
           margin: 16px; color: var(--fg); }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .row { display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    .ctrl { height:40px; padding: 8px 12px; font-size:16px; }
    select.ctrl, input.ctrl { border:1px solid var(--border); border-radius:8px; }
    button.ctrl { background:#111; color:#fff; border:none; border-radius:8px; }
    button.ghost { background:#fff; color:#111; border:1px solid var(--border); }
    button:disabled { opacity:.6; }
    .hint { color:var(--muted); font-size:13px; }
    .section { margin: 16px 0; }
    #preview { width:100%; height:260px; border:1px solid var(--border); border-radius:8px;
               font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
               padding:12px; white-space:pre-wrap; }
    textarea.ctrl { width: 320px; height: 120px; }
    .grid { display:grid; grid-template-columns: 140px 1fr; gap:10px 12px; align-items:center; }
    @media (max-width:560px){ .grid { grid-template-columns: 1fr; } textarea.ctrl{width:100%;} }
  </style>
</head>
<body>
  <h1>CTA Report Helper（テンプレ切替・スマホ最適化）</h1>

  <div class="row section">
    <label for="tplSel">テンプレート選択</label>
    <select id="tplSel" class="ctrl">
      <option value="coronary_ct" selected>冠動脈</option>
      <option value="bypass_ct">バイパス</option>
      <option value="laa_pv_ct">左心耳・肺静脈</option>
      <option value="tavi">TAVI</option>
    </select>
    <span class="hint">※選択するとテンプレートと候補語を読み込みます（同階層のJSONがあれば優先）</span>
  </div>

  <div class="row section">
    <label for="scoreInput">スコア：</label>
    <input id="scoreInput" class="ctrl" placeholder="例：450" />
  </div>

  <div id="lesionArea" class="section">
    <div class="grid">
      <div>所見入力</div><div></div>

      <label>枝</label>
      <div class="row">
        <select id="arterySel" class="ctrl"></select>
        <input id="arteryFree" class="ctrl" placeholder="その他（手入力）" style="display:none; width:220px;" />
      </div>

      <label>狭窄率</label>
      <select id="stenosisSel" class="ctrl" style="width:220px;"></select>

      <label>プラーク</label>
      <select id="plaqueSel" class="ctrl" style="width:220px;"></select>

      <label>特殊所見</label>
      <textarea id="specialArea" class="ctrl"
        placeholder="複数ある場合は改行／カンマ区切りで入力（例：Positive remodeling, Spotty calcification）"></textarea>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="addLineBtn" class="ctrl">この内容で1行追加</button>
      <span class="hint">整形：基本は半角スペース連結／特殊所見は（A, B）</span>
    </div>
  </div>

  <div class="row section">
    <button id="addBrBtn" class="ctrl ghost">改行を追加</button>
    <button id="undoBtn" class="ctrl ghost">直前を取り消し</button>
    <button id="clearAllBtn" class="ctrl ghost">全消去（スコア含む）</button>
  </div>

  <div class="section">
    <div id="preview" aria-label="レポートプレビュー"></div>
  </div>

  <div class="row section">
    <button id="copyBtn" class="ctrl">テキストをコピー</button>
    <button id="mailtoBtn" class="ctrl ghost">メール作成（標準メーラー）</button>
    <button id="gmailAppBtn" class="ctrl ghost">Gmailアプリで作成（推奨）</button>
    <button id="gmailWebBtn" class="ctrl ghost">Gmail（ブラウザ）で作成</button>
  </div>

  <script>
    // -----------------------
    // フォールバック・テンプレ定義（外部JSONが無い/壊れていても起動）
    // -----------------------
    const TPL_FALLBACKS = {
      "coronary_ct": {
        template_id: "coronary_ct",
        meta: { title: "＜冠動脈＞（担当技師：志賀）", score_label: "石灰化スコア：", version: "v2" },
        sections: [{
          name: "冠動脈所見",
          fields: [
            { key: "artery",   label: "枝",
              options: ["#1","#2","#3","#4PL","#4PD","#5","#6","#7","#8","#9","#10","#11","#12","#13","#14","#15","HL","PL","Sep","その他（手入力）"] },
            { key: "stenosis", label: "狭窄率", options: ["0%","25%","50%","75%","90%","100%"] },
            { key: "plaque",   label: "プラーク", options: ["正常","石灰化プラーク","非石灰化プラーク","混合プラーク"] },
            { key: "special",  label: "特殊所見", multi:true,
              options: ["Positive remodeling","Spotty calcification","Napkin-ring sign"] }
          ]
        }]
      },
      "bypass_ct": {
        template_id: "bypass_ct",
        meta: { title: "＜冠動脈バイパス＞（担当技師：志賀）", score_label: "石灰化スコア：", version: "v1" },
        sections: [{
          name: "CABG所見",
          fields: [
            { key: "graft",   label: "グラフト", options: ["（選択）","LITA","RITA","SVG","GEA","RA"] },
            { key: "patency", label: "開存状態", options: ["（選択）","開存","狭窄","閉塞"] },
            { key: "anast",   label: "吻合部",   options: ["（選択）","良好","不良","評価困難"] },
            { key: "special", label: "特殊所見", multi:true,
              options:["金属クリップ影響","motion artifact","評価困難"] }
          ]
        }]
      },
      "laa_pv_ct": {
        template_id: "laa_pv_ct",
        meta: { title: "＜左心耳・肺静脈＞（担当技師：志賀）", score_label: "備考：", version: "v1" },
        sections: [{
          name: "所見",
          fields: [
            { key:"finding", label:"所見", options:["（選択）","左心耳血栓疑い","肺静脈狭窄疑い","異常所見なし"] },
            { key:"special", label:"特殊所見", multi:true, options:["追加所見なし"] }
          ]
        }]
      },
      "tavi": {
        template_id: "tavi",
        meta: { title: "＜TAVI計測＞（担当技師：志賀）", score_label: "備考：", version:"v1" },
        sections: [{
          name:"TAVI",
          fields:[
            { key:"finding", label:"所見", options:["（選択）","弁輪計測完了","石灰化強い","アクセス良好"] },
            { key:"special", label:"特殊所見", multi:true, options:["注意所見なし"] }
          ]
        }]
      }
    };

    // -----------------------
    // 状態
    // -----------------------
    let currentTemplate = null;   // 読み込んだテンプレ
    let currentData = { saved: [], candidates: {} }; // data_*.json
    let outputLines = [];         // ユーザー追加行
    let outputText = "";          // プレビュー文字列

    // -----------------------
    // 汎用：JSON読込（404許容・フォールバック対応）
    // -----------------------
    async function loadJson(path, fallbackObj=null) {
      try {
        const res = await fetch(path, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch ${path} -> ${res.status}`);
        return await res.json();
      } catch (e) {
        if (fallbackObj!==null) return structuredClone(fallbackObj);
        throw e;
      }
    }

    // -----------------------
    // テンプレ読み込み
    // -----------------------
    async function loadTemplateById(tid) {
      const filename =
        tid === "coronary_ct" ? "template_coronary.json" :
        tid === "bypass_ct"   ? "template_bypass.json"   :
        tid === "laa_pv_ct"   ? "template_laa_pv.json"   :
        tid === "tavi"        ? "tamplate_tavi.json"     : // 既存の綴りに合わせてあります
                                `template_${tid}.json`;

      const tplFallback = TPL_FALLBACKS[tid] || TPL_FALLBACKS["coronary_ct"];
      currentTemplate = await loadJson(filename, tplFallback);

      // ヘッダを初期注入（undefinedガード）
      injectHeaderToOutput();

      // 候補UIの準備
      prepareLesionSections();

      // 付随データ読み込み（404でも続行）
      await loadDataById(tid);

      // プレビュー再描画
      renderOutput();
    }

    // -----------------------
    // 付随データ読み込み（404許容）
    // -----------------------
    async function loadDataById(tid) {
      const path =
        tid === "coronary_ct" ? "data_coronary_ct.json" :
        tid === "bypass_ct"   ? "data_bypass_ct.json"   :
        tid === "laa_pv_ct"   ? "data_laa_pv_ct.json"   :
                                `data_${tid}.json`;
      try {
        currentData = await loadJson(path, { saved: [], candidates: {} });
      } catch(e) {
        currentData = { saved: [], candidates: {} };
      }
    }

    // -----------------------
    // ヘッダ注入（undefined防止）
    // -----------------------
    function injectHeaderToOutput() {
      const title = currentTemplate?.meta?.title || "＜冠動脈＞（担当技師：）";
      const scoreLabel = currentTemplate?.meta?.score_label || "スコア：";
      outputLines = []; // テンプレ切替で本文はクリア
      outputText = `${title}\n${scoreLabel}\n`;
      renderOutput();
    }

    function renderOutput() {
      const body = outputLines.join("\n");
      const text = outputText + body;
      document.getElementById("preview").textContent = text || "";
    }

    // -----------------------
    // UI 構築
    // -----------------------
    function prepareLesionSections() {
      // 対象テンプレの最初のセクションを使う（冠動脈ほかシンプル想定）
      const sec = currentTemplate?.sections?.[0] || {fields:[]};

      const arterySel   = document.getElementById("arterySel");
      const arteryFree  = document.getElementById("arteryFree");
      const stenosisSel = document.getElementById("stenosisSel");
      const plaqueSel   = document.getElementById("plaqueSel");
      const specialArea = document.getElementById("specialArea");

      // セレクト初期化
      function fillSelect(sel, opts) {
        sel.innerHTML = "";
        for (const o of opts) {
          const opt = document.createElement("option");
          opt.value = o; opt.textContent = o;
          sel.appendChild(opt);
        }
      }

      const fArtery   = sec.fields.find(f=>f.key==="artery")   || { options:["（選択）"] };
      const fStenosis = sec.fields.find(f=>f.key==="stenosis") || { options:["（選択）"] };
      const fPlaque   = sec.fields.find(f=>f.key==="plaque")   || { options:["（選択）"] };
      const fSpecial  = sec.fields.find(f=>f.key==="special")  || { options:[], multi:true };

      // 候補リスト
      fillSelect(arterySel,   fArtery.options);
      fillSelect(stenosisSel, fStenosis.options);
      fillSelect(plaqueSel,   fPlaque.options);
      specialArea.value = fSpecial.options.join("\n");

      // 「その他（手入力）」切替
      function toggleArteryFree() {
        const v = arterySel.value;
        const show = (v === "その他（手入力）");
        arteryFree.style.display = show ? "inline-block" : "none";
        if (!show) arteryFree.value = "";
      }
      arterySel.onchange = toggleArteryFree;
      toggleArteryFree();
    }

    // -----------------------
    // 行追加／操作
    // -----------------------
    function getSpecialsText(raw) {
      // 改行 or カンマ区切り → トリムして重複排除 → （A, B）
      const parts = raw.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
      const uniq = [...new Set(parts)];
      return uniq.length ? `（${uniq.join(", ")}）` : "";
    }

    document.getElementById("addLineBtn").onclick = () => {
      const arterySel   = document.getElementById("arterySel");
      const arteryFree  = document.getElementById("arteryFree");
      const stenosisSel = document.getElementById("stenosisSel");
      const plaqueSel   = document.getElementById("plaqueSel");
      const specialArea = document.getElementById("specialArea");

      const a = (arterySel.value === "その他（手入力）" ? (arteryFree.value || "不明") : arterySel.value || "");
      const s = stenosisSel.value || "";
      const p = plaqueSel.value || "";
      const sp = getSpecialsText(specialArea.value);

      // ver.1の仕様：自動文章整形なし、半角スペース結合＋特殊所見は（…）
      const line = `${a}： ${s} ${p}${sp}`.trim();
      if (line) outputLines.push(line);
      renderOutput();
    };

    document.getElementById("addBrBtn").onclick = () => {
      outputLines.push("");
      renderOutput();
    };

    document.getElementById("undoBtn").onclick = () => {
      outputLines.pop();
      renderOutput();
    };

    document.getElementById("clearAllBtn").onclick = () => {
      injectHeaderToOutput();
      document.getElementById("scoreInput").value = "";
    };

    // スコア反映：ヘッダ2行目に常に置く
    document.getElementById("scoreInput").oninput = (e) => {
      const scoreLabel = currentTemplate?.meta?.score_label || "スコア：";
      // 先頭2行を作り直し
      const title = currentTemplate?.meta?.title || "＜冠動脈＞（担当技師：）";
      const val = (e.target.value || "").trim();
      outputText = `${title}\n${scoreLabel}${val ? val : ""}\n`;
      renderOutput();
    };

    // -----------------------
    // メール作成
    // -----------------------
    function getMailBody() {
      return document.getElementById("preview").textContent || "";
    }

    document.getElementById("mailtoBtn").onclick = () => {
      const body = encodeURIComponent(getMailBody());
      const url = `mailto:?subject=${encodeURIComponent("CTA所見")}&body=${body}`;
      location.href = url;
    };

    // iOS/AndroidのGmailアプリ
    document.getElementById("gmailAppBtn").onclick = () => {
      const body = encodeURIComponent(getMailBody());
      // Gmail アプリ URL スキーム（iOS/Android共通）
      const url = `googlegmail:///co?to=&subject=${encodeURIComponent("CTA所見")}&body=${body}`;
      location.href = url;
    };

    // ブラウザでGmail
    document.getElementById("gmailWebBtn").onclick = () => {
      const body = encodeURIComponent(getMailBody());
      const url = `https://mail.google.com/mail/?view=cm&fs=1&tf=1&to=&su=${encodeURIComponent("CTA所見")}&body=${body}`;
      window.open(url, "_blank");
    };

    // クリップボード
    document.getElementById("copyBtn").onclick = async () => {
      try {
        await navigator.clipboard.writeText(getMailBody());
        alert("コピーしました");
      } catch {
        alert("コピーに失敗しました（ブラウザの権限をご確認ください）");
      }
    };

    // -----------------------
    // 初期化
    // -----------------------
    document.getElementById("tplSel").onchange = async (e) => {
      await loadTemplateById(e.target.value);
    };

    // 最初は冠動脈を読み込む
    (async () => {
      await loadTemplateById("coronary_ct");
    })();
  </script>
</body>
</html>
